# 麻雀点数計算ロジック実装TODO

このTODOリストは麻雀点数計算のロジックを実装するためのTODOです。
点数計算のおおまかな仕様は `/docs/score-calculation/` にまとまっています。

## 概要
- **目標**: 問題データの正解事前計算方式から、実行時自動計算方式へ移行
- **対応役**: 役満含む全役（40役以上）
- **テスト**: 網羅的テスト（50ケース）をTDD方式で作成
- **ルール**: 標準ルール（Mリーグ）のみ

---

## Phase 1: 基盤構築（2-3日）

### 1.1 環境セットアップ
- [x] Jestのインストールと設定
- [x] `/lib/calculate/`ディレクトリ作成
- [x] 型定義の拡張（`/lib/types/mahjong.ts`に`MeldType`, `Meld`, `WaitType`, `MeldPattern`を追加）

### 1.2 ユーティリティ実装（TDD）
- [ ] `tile-comparator.test.ts`テスト作成
- [ ] `tile-comparator.ts`実装（牌のソート・比較・同一判定）
- [ ] `meld-detector.test.ts`テスト作成
- [ ] `meld-detector.ts`実装（順子・刻子・対子の検出）

---

## Phase 2: 手牌解析（3-4日）

### 2.1 標準形の手牌解析（TDD）
- [ ] `hand-analyzer.test.ts`テスト作成（5ケース）
  - 標準形（4面子1雀頭）の単一パターン
  - 標準形の複数パターン（112233 → 2通り）
  - 七対子
  - 国士無双
  - 不正な手牌（エラーケース）
- [ ] `hand-analyzer.ts`実装
  - 再帰的バックトラッキングで面子分解
  - 待ち形の判定ロジック
  - 特殊形（七対子、国士無双）の検出

---

## Phase 3: 基本役判定（4-5日）

### 3.1 基本役の実装（TDD）
- [ ] `yaku-detector.test.ts`テスト作成（7役、各2ケース = 14ケース）
- [ ] `yaku/yaku-definitions.ts`実装（役の定義構造）
- [ ] `yaku/basic-yaku.ts`実装（リーチ、ツモ、平和、タンヤオ）
- [ ] `yaku/yakuhai-yaku.ts`実装（役牌5種）

### 3.2 ドラカウント（TDD）
- [ ] `dora-counter.test.ts`テスト作成
- [ ] `utils/dora-counter.ts`実装

### 3.3 役判定の統合
- [ ] `yaku/index.ts`実装（全役チェックの統合）

---

## Phase 4: 符・点数計算（3-4日）

### 4.1 符計算（TDD）
- [ ] `fu-calculator.test.ts`テスト作成（5ケース）
  - 平和ツモ（20符）
  - 七対子（25符）
  - 面前ロン30符
  - 刻子の符計算
  - 待ち形の符
- [ ] `fu-calculator.ts`実装

### 4.2 点数計算（TDD）
- [ ] `score-calculator.test.ts`テスト作成（5ケース）
  - 満貫未満（3翻30符）
  - 満貫（4翻30符）
  - 跳満（6翻）
  - 倍満（8翻）
  - 役満（32000点）
- [ ] `score-calculator.ts`実装

### 4.3 翻数計算
- [ ] `han-calculator.ts`実装（シンプルな集計ロジック）

---

## Phase 5: 統合と初期動作確認（1-2日）

### 5.1 公開APIの実装
- [ ] `lib/calculate/index.ts`実装（calculateScore関数）
- [ ] 既存問題p0001での動作確認

### 5.2 問題管理ロジックの修正
- [ ] `/lib/problem/index.ts`修正
  - `calculateScore`関数を使用
  - `correctAnswer`フィールドは参照しない

### 5.3 統合テスト
- [ ] `integration.test.ts`テスト作成（p0001のテスト）

---

## Phase 6: 頻出役実装（5-6日）

### 6.1 順子系の役（TDD）
- [ ] 一盃口、三色同順、一気通貫のテスト作成（各2ケース）
- [ ] `yaku/sequence-yaku.ts`実装

### 6.2 刻子系の役（TDD）
- [ ] 対々和、三暗刻、三色同刻、三槓子のテスト作成（各2ケース）
- [ ] `yaku/triplet-yaku.ts`実装

### 6.3 么九系の役（TDD）
- [ ] 混全帯、純全帯、混老頭のテスト作成（各2ケース）
- [ ] `yaku/terminal-yaku.ts`実装

### 6.4 色系の役（TDD）
- [ ] 混一色、清一色のテスト作成（各2ケース）
- [ ] `yaku/color-yaku.ts`実装

### 6.5 特殊役（TDD）
- [ ] 七対子、二盃口のテスト作成（各2ケース）
- [ ] `yaku/special-yaku.ts`実装

### 6.6 統合テスト追加
- [ ] `integration.test.ts`に10ケース追加（実戦パターン）

---

## Phase 7: 偶発役実装（2日）

### 7.1 偶発役の実装（TDD）
- [ ] 嶺上開花、槍槓、海底摸月、河底撈魚のテスト作成（各1ケース）
- [ ] `yaku/special-yaku.ts`に偶発役を追加実装

---

## Phase 8: 役満実装（4-5日）

### 8.1 役満の実装（TDD）
- [ ] 役満13種+二倍役満3種のテスト作成（各1ケース = 16ケース）
- [ ] `yaku/yakuman.ts`実装
- [ ] `hand-analyzer.ts`の拡張（国士無双の特殊処理）

### 8.2 統合テスト追加
- [ ] `integration.test.ts`に役満パターン5ケース追加

---

## Phase 9: 総合テストとエッジケース（2-3日）

### 9.1 エッジケーステスト
- [ ] エッジケーステスト作成（5ケース）
  - 役牌複合（場風=自風=東で2翻）
  - 複数の面子構成で符が変わる例
  - 喰い下がり（混一色の鳴き）
  - 親の点数計算
  - 数え役満（13翻以上）

### 9.2 カバレッジ確認
- [ ] テストカバレッジ90%以上を確認

### 9.3 パフォーマンステスト
- [ ] 1問あたり10ms以内の計算速度を確認

---

## Phase 10: データ移行（1-2日）

### 10.1 問題データの修正
- [ ] `problems.json`から`correctAnswer`フィールドを削除
- [ ] 必要に応じて問題を追加（5-10問）

### 10.2 動作確認
- [ ] 全画面（home → practice → result）で動作確認
- [ ] ブラウザでの実機テスト

### 10.3 ドキュメント更新
- [ ] CLAUDE.mdの更新（実装完了を反映）
- [ ] APIドキュメントの作成（`/docs/calculate-api.md`）

---

## 成功基準

- [ ] 全50テストケースが合格
- [ ] コードカバレッジ90%以上
- [ ] p0001の問題が正しく計算される（リーチ・ツモ・發 = 3翻30符 = 親2000・子1000）
- [ ] 計算速度10ms以内（1問あたり）
- [ ] ブラウザでE2Eテストが通過

---

## 実装する40役一覧

### 基本役（7役）
リーチ、ツモ、平和、タンヤオ、役牌、一発、ドラ（赤・表・裏）

### 頻出役（12役）
一盃口、三色同順、一気通貫、対々和、三暗刻、混全帯、純全帯、混一色、清一色、七対子、三色同刻、三槓子

### 偶発役（6役）
嶺上開花、槍槓、海底摸月、河底撈魚、二盃口、混老頭

### 役満（13役+二倍役満3つ）
国士無双（13面）、四暗刻（単騎）、大三元、小四喜、大四喜、字一色、清老頭、緑一色、九蓮宝燈（純正）、四槓子、天和、地和

---

## 注意事項

### エラーハンドリング
- 不正な手牌（14枚でない）
- 和了形でない手牌
- ドラ表示牌が不正

### 複数の面子構成
- 全パターンを列挙し、最も高得点の構成を選択

### 役の排他性
- 一盃口と二盃口は両立しない（高い方を優先）
- 平和と役牌は両立しない

### 喰い下がり
- 混一色: 門前3翻 → 鳴き2翻
- 純全帯: 門前3翻 → 鳴き2翻
- 一気通貫: 門前2翻 → 鳴き2翻（変わらない）
- 三色同順: 門前2翻 → 鳴き2翻（変わらない）
